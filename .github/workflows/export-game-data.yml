name: Export Game Data

on:
  workflow_dispatch:
    inputs:
      game_repo:
        description: "Target game repo (owner/name). Overrides UA_GAME_REPO."
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - "docs/data/**"
      - "docs/assets/characters/**"
      - "docs/scripts/export-game-data.mjs"
      - ".github/workflows/export-game-data.yml"

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4

      - name: Resolve target repo
        shell: bash
        run: |
          if [ -n "${{ inputs.game_repo }}" ]; then
            echo "GAME_REPO=${{ inputs.game_repo }}" >> "$GITHUB_ENV"
          elif [ -n "${{ vars.UA_GAME_REPO }}" ]; then
            echo "GAME_REPO=${{ vars.UA_GAME_REPO }}" >> "$GITHUB_ENV"
          else
            echo "Set workflow input game_repo or repo variable UA_GAME_REPO." >&2
            exit 1
          fi
          if [ -z "${{ secrets.UA_SYNC_TOKEN }}" ]; then
            echo "Missing UA_SYNC_TOKEN secret (needs write access to game repo)." >&2
            exit 1
          fi

      - name: Checkout game repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GAME_REPO }}
          token: ${{ secrets.UA_SYNC_TOKEN }}
          path: game

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install exporter dependencies
        run: |
          cd docs/scripts
          npm install

      - name: Export data and assets
        run: |
          node docs/scripts/export-game-data.mjs --out game/packages/data/src --assets-out game/apps/client/public/assets/characters

      - name: Commit and push
        shell: bash
        run: |
          cd game
          if git status --porcelain | grep -q .; then
            git config user.name "ua-bot"
            git config user.email "ua-bot@users.noreply.github.com"
            git add packages/data/src apps/client/public/assets/characters
            git commit -m "chore: sync game data"
            git push
          else
            echo "No changes to commit."
          fi
